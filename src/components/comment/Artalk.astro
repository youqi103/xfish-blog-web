---
// src/components/Artalk.astro
// 完全重写，解决SSR和异步加载问题

interface Props {
  path: string;
}

const { path } = Astro.props;

// 从Astro环境变量获取
const ARTALK_SERVER = import.meta.env.PUBLIC_ARTALK_SERVER || 'http://localhost:3000/artalk';
const SITE_TITLE = 'Your Blog Title'; // 建议从siteConfig获取
---

<!-- 挂载点（必须确保ID唯一且存在） -->
<div id="artalk-comments-container"></div>

<!-- Artalk CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/artalk@2.7.3/dist/Artalk.css"
/>

<!-- Artalk JS（使用is:inline避免Astro打包问题） -->
<script
  src="https://unpkg.com/artalk@2.7.3/dist/Artalk.js"
  is:inline
></script>

<!-- 初始化脚本（is:inline确保在浏览器执行） -->
<script is:inline define:vars={{ ARTALK_SERVER, path, SITE_TITLE }}>
  // 只在浏览器环境执行
  if (typeof window === 'undefined') {
    console.warn('Artalk: Not running in browser environment');
    return;
  }

  // 等待Artalk库加载完成
  function waitForArtalk(maxRetries = 50, interval = 100) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      
      const check = () => {
        attempts++;
        if (window.Artalk) {
          resolve(window.Artalk);
        } else if (attempts >= maxRetries) {
          reject(new Error('Artalk failed to load after multiple attempts'));
        } else {
          setTimeout(check, interval);
        }
      };
      
      check();
    });
  }

  // 初始化函数
  async function initArtalk() {
    try {
      // 1. 等待Artalk加载
      await waitForArtalk();
      
      // 2. 确保DOM元素存在
      const container = document.getElementById('artalk-comments-container');
      if (!container) {
        throw new Error('Artalk container #artalk-comments-container not found');
      }

      // 3. 深色模式检测（安全判断）
      function getDarkMode() {
        const html = document.documentElement;
        return html ? html.classList.contains('dark') : false;
      }

      // 4. 配置Artalk
      const artalk = new window.Artalk({
        el: '#artalk-comments-container', // 使用ID选择器
        server: ARTALK_SERVER,
        pageKey: path,
        pageTitle: document.title || SITE_TITLE,
        site: SITE_TITLE,
        locale: 'zh-CN',
        placeholder: '留下你的评论...',
        // 图片上传
        imgUploader: async (file) => {
          const formData = new FormData();
          formData.append('file', file);
          
          const res = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
            credentials: 'include' // 如果需要cookie
          });
          
          const data = await res.json();
          if (data.success) return data.url;
          throw new Error(data.message || '上传失败');
        },
        // 登录配置（可选）
        login: localStorage.getItem('token') ? true : false,
        user: (() => {
          const token = localStorage.getItem('token');
          if (!token) return undefined;
          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return {
              id: payload.id,
              nick: payload.nickname,
              email: payload.email,
              avatar: payload.avatar,
              token: token,
            };
          } catch {
            return undefined;
          }
        })(),
      });

      // 5. 监听深色模式变化（安全判断）
      const html = document.documentElement;
      if (html) {
        const observer = new MutationObserver(() => {
          artalk.setDarkMode(getDarkMode());
        });
        
        observer.observe(html, {
          attributes: true,
          attributeFilter: ['class'],
        });

        // 初始设置
        artalk.setDarkMode(getDarkMode());
      }

      console.log('Artalk initialized successfully');
    } catch (error) {
      console.error('Artalk initialization error:', error);
      // 显示用户友好错误
      const container = document.getElementById('artalk-comments-container');
      if (container) {
        container.innerHTML = `
          <div style="padding: 20px; color: #f00; text-align: center;">
            评论系统加载失败，请刷新页面重试
          </div>
        `;
      }
    }
  }

  // 6. 确保DOM加载完成后再初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initArtalk);
  } else {
    initArtalk();
  }
</script>